{% extends 'base.html' %}

{% block title %}All Products - SmartShop{% endblock %}

{% block content %}
  <h2 class="mb-3">All Products</h2>

  <!-- Smart Search Section -->
  <div class="row mb-4">
    <div class="col-md-8 position-relative">
      <input
        type="text"
        id="searchInput"
        class="form-control"
        placeholder="Search products (e.g. wireless earbuds for gym, skincare for sensitive skin)"
        autocomplete="off"
      />

      <!-- Autocomplete dropdown -->
      <div
        id="autocomplete-list"
        class="border bg-white position-absolute w-100"
        style="z-index: 1000;"
      ></div>

      <div id="detectedFilters" class="mt-2" style="display:none;"></div>
    </div>

    <div class="col-md-2">
      <button class="btn btn-primary w-100" onclick="performSearch()">Search</button>
    </div>
  </div>

  <!-- Smart Search Results -->
  <div id="searchResults" class="row mb-4" style="display: none;"></div>

  <!-- All Products Grid (shown when no search) -->
  <div id="productsGrid">
    <div class="row">
      {% for product in products %}
        <div class="col-md-4 mb-3">
          <div class="card h-100">

            {% if product.image_url %}
              <div class="product-image-wrapper" style="height:180px;">
                <img src="{{ product.image_url }}" class="product-image" alt="{{ product.name }}">
              </div>
            {% endif %}

            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{ product.name }}</h5>
              <p class="text-muted mb-1">{{ product.category.name }}</p>
              <p class="fw-bold text-success mb-2">${{ product.price }}</p>

              <div class="mt-auto">
                <a href="{% url 'product_detail' product.id %}" class="btn btn-primary btn-sm">View Product</a>
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <p>No products available.</p>
      {% endfor %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
function performSearch() {
    const query = document.getElementById("searchInput").value.trim();
    const resultsContainer = document.getElementById("searchResults");
    const productsGrid = document.getElementById("productsGrid");

    if (!query) {
        resultsContainer.style.display = "none";
        resultsContainer.innerHTML = "";
        if (productsGrid) productsGrid.style.display = "block";
        return;
    }

    if (productsGrid) productsGrid.style.display = "none";
    resultsContainer.style.display = "flex";
    resultsContainer.innerHTML = "";

    fetch(`/search/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            resultsContainer.innerHTML = "";

            // Render detected filters pill
            const filtersDiv = document.getElementById('detectedFilters');
            if (data.parsed) {
                const parts = [];
                if (data.parsed.mapped_category) parts.push(`<strong>Category:</strong> ${data.parsed.mapped_category}`);
                if (data.parsed.max_price) parts.push(`<strong>Max Price:</strong> $${data.parsed.max_price}`);
                if (data.parsed.keywords && data.parsed.keywords.length) parts.push(`<strong>Keywords:</strong> ${data.parsed.keywords.join(', ')}`);

                if (parts.length) {
                    let note = parts.join(' • ');
                    if (data.applied_filters && data.applied_filters.price_relaxed) {
                        note += ' • <em>Price constraint relaxed for alternatives</em>';
                    }
                    filtersDiv.innerHTML = `<div class="alert alert-secondary py-1 px-2" role="alert">Detected: ${note}</div>`;
                    filtersDiv.style.display = 'block';
                } else {
                    filtersDiv.style.display = 'none';
                    filtersDiv.innerHTML = '';
                }
            } else {
                filtersDiv.style.display = 'none';
                filtersDiv.innerHTML = '';
            }

            if (!data.results || data.results.length === 0) {
                resultsContainer.innerHTML = "<p>No products found.</p>";
                return;
            }

            data.results.forEach(product => {
                const card = document.createElement("div");
                card.className = "col-md-4 mb-3";
                card.innerHTML = `
                    <div class="card shadow-sm h-100">
                        <div class="product-image-wrapper" style="height:180px;">
                            <img src="${product.image_url}" class="product-image" alt="${product.name}">
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">${product.name}</h5>
                            <p class="text-muted">${product.category}</p>
                            <p class="fw-bold text-success">$${product.price}</p>
                            <button class="btn btn-primary btn-sm" onclick="viewProduct(${product.id})">View Product</button>
                        </div>
                    </div>
                `;
                resultsContainer.appendChild(card);
            });
        })
        .catch(() => { resultsContainer.innerHTML = "<p class='text-danger'>Search failed. Please try again.</p>"; });
}

let _searchTimer = null;
document.getElementById('searchInput').addEventListener('input', function(e) {
    clearTimeout(_searchTimer);
    _searchTimer = setTimeout(() => performSearch(), 350);
});

function viewProduct(productId) { window.location.href = `/products/${productId}/`; }
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const searchInput = document.getElementById("searchInput");
  const suggestionBox = document.getElementById("autocomplete-list");

  if (!searchInput || !suggestionBox) return;

  searchInput.addEventListener("input", async function () {
    const query = this.value.trim();
    suggestionBox.innerHTML = "";

    if (query.length < 2) return;

    try {
      const res = await fetch(`/search/autocomplete/?q=${query}`);
      const data = await res.json();

      data.suggestions.forEach(item => {
        const div = document.createElement("div");
        div.className = "autocomplete-item";
        div.textContent = item;

        div.onclick = () => {
          searchInput.value = item;
          suggestionBox.innerHTML = "";
        };

        suggestionBox.appendChild(div);
      });
    } catch (e) {
      console.error("Autocomplete error:", e);
    }
  });
});
</script>


{% endblock %}
