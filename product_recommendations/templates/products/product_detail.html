{% extends 'base.html' %}
{% block title %}{{ product.name }} - SmartShop{% endblock %}

{% block content %}
  <div class="card card-shadow mb-4">
    <div class="card-body">
      <div class="row">
        <!-- Image column -->
        <div class="col-md-5 d-flex align-items-center justify-content-center">
          <div class="product-image-wrapper rounded d-flex align-items-center justify-content-center" style="height:320px; width:100%;">
            {% if product.image_url %}
              <img 
                src="{{ product.image_url }}" 
                class="product-image img-fluid"
                style="max-height: 100%; object-fit: contain;"
                alt="{{ product.name }}"
              >
            {% else %}
              <div class="text-muted">No image</div>
            {% endif %}
          </div>
        </div>

        <!-- Info column -->
        <div class="col-md-7">
          <div class="d-flex align-items-center mb-3">
            <a class="btn btn-primary me-3" href="javascript:void(0);" onclick="goBack();">&larr; Back</a>
            <h2 class="mb-1">{{ product.name }}</h2>
          </div>

          <p class="text-muted mb-2">{{ product.category.name }}</p>
          <p class="mb-3">{{ product.description }}</p>

          <div class="d-flex align-items-center mb-3">
            <p class="fw-bold text-success fs-4 mb-0 me-3">${{ product.price }}</p>
            {% if product.stock > 0 %}
              <span class="badge bg-success">In Stock</span>
            {% else %}
              <span class="badge bg-danger">Out of Stock</span>
            {% endif %}
          </div>

          <a href="#reviews" class="btn btn-primary btn-sm">View Reviews</a>

          {% if ai_description %}
            <div class="mt-3">
              <h6 class="text-muted">Product Description</h6>
              <p class="mb-0">{{ ai_description }}</p>
            </div>
          {% endif %}

          <div class="mt-4">
            <h6 class="text-muted">Product Details</h6>
            <ul class="list-unstyled small">
              {% if product.brand %}
                <li><strong>Brand:</strong> {{ product.brand }}</li>
              {% endif %}
              {% if product.use_case %}
                <li><strong>Use Case:</strong> {{ product.use_case }}</li>
              {% endif %}
              {% if product.material %}
                <li><strong>Material:</strong> {{ product.material }}</li>
              {% endif %}
              {% if product.ingredients %}
                <li><strong>Ingredients:</strong> {{ product.ingredients }}</li>
              {% endif %}
              {% if product.care_instructions %}
                <li><strong>Care Instructions:</strong> {{ product.care_instructions }}</li>
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- LEFT: Reviews list -->
    <div class="col-md-7">
      <div id="reviews">
        <div class="card mb-4">
          <div class="card-body">
            <h5 class="mb-3">Customer Reviews</h5>

            {% if reviews %}
              {% for review in reviews %}
                <div class="mb-3 border-bottom pb-2">
                  <div class="d-flex justify-content-between">
                    <strong>{{ review.user.username }}</strong>
                    <span class="text-muted">{{ review.rating }} / 5</span>
                  </div>
                  <p class="mb-0">{{ review.review_text }}</p>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">No reviews yet. Be the first to write one!</p>
            {% endif %}

          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: AI Review Summary + Submit Review form -->
    <div class="col-md-5">
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="mb-3">AI Review Summary</h5>

          {% if review_summary %}
            <p><strong>Summary:</strong> {{ review_summary.summary }}</p>

            <p class="mb-1"><strong>Pros:</strong></p>
            <ul>
              {% for pro in review_summary.pros %}
                <li>{{ pro }}</li>
              {% empty %}
                <li class="text-muted">No pros found.</li>
              {% endfor %}
            </ul>

            <p class="mb-1"><strong>Cons:</strong></p>
            <ul>
              {% for con in review_summary.cons %}
                <li>{{ con }}</li>
              {% empty %}
                <li class="text-muted">No cons found.</li>
              {% endfor %}
            </ul>

            <p class="mt-2">
              <strong>Sentiment:</strong>
              <span class="badge {% if review_summary.sentiment == 'Positive' %}bg-success{% elif review_summary.sentiment == 'Negative' %}bg-danger{% else %}bg-secondary{% endif %}">
                {% if review_summary.sentiment %}{{ review_summary.sentiment }}{% else %}Unknown{% endif %}
              </span>
            </p>

          {% else %}
            <p class="text-muted">No AI review summary available yet.</p>
          {% endif %}
        </div>
      </div>

      <!-- Submit Review Form -->
      <div class="card">
        <div class="card-body">
          <h5 class="mb-3">Submit a Review</h5>

          {% if user.is_authenticated %}
            <form method="post" action="{% url 'submit_review' product.id %}">
              {% csrf_token %}
              <div class="mb-3">
                <label for="id_rating" class="form-label">Rating</label>
                <select name="rating" id="id_rating" class="form-select" required>
                  <option value="">Choose...</option>
                  <option value="5">5 - Excellent</option>
                  <option value="4">4 - Good</option>
                  <option value="3">3 - Average</option>
                  <option value="2">2 - Poor</option>
                  <option value="1">1 - Terrible</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="id_review_text" class="form-label">Review</label>
                <textarea name="review_text" id="id_review_text" class="form-control" rows="4" required></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Submit Review</button>
            </form>
          {% else %}
            <p>Please <a href="{% url 'login' %}?next={{ request.path }}">log in</a> to submit a review.</p>
          {% endif %}

        </div>
      </div>

    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
function goBack() {
    var ref = document.referrer || "";
    var productsPath = "{% url 'products_page' %}";
    if (!ref || ref.indexOf(productsPath) !== -1) {
        window.location.href = productsPath;
        return;
    }
    window.history.back();
}
</script>
{% endblock %}

